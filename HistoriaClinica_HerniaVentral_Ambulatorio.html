
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Historia Clínica – Hernia Ventral Compleja (Ambulatorio)</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height: 1.4; }
    body { margin: 0; background: #fafafa; color: #111; }
    header {
      position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #eaeaea; padding: 12px 16px;
      display: flex; align-items: center; gap: 12px; justify-content: space-between; flex-wrap: wrap;
    }
    h1 { font-size: 18px; margin: 0; }
    main { max-width: 980px; margin: 0 auto; padding: 16px; }
    section { background: #fff; border: 1px solid #eaeaea; border-radius: 10px; padding: 14px 16px; margin: 12px 0; }
    section h2 { font-size: 16px; margin: 0 0 8px 0; display: flex; align-items: center; gap: 8px; }
    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 10px; }
    .col-12 { grid-column: span 12; } .col-8 { grid-column: span 8; } .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; } .col-3 { grid-column: span 3; } .col-2 { grid-column: span 2; }
    label { font-size: 13px; color: #333; display: block; margin-bottom: 4px; }
    input, select, textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px; background: #fff; }
    textarea { min-height: 72px; resize: vertical; }
    .muted { color: #666; font-size: 12px; }
    .chip { display: inline-block; padding: 4px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; margin-right: 6px; background: #f4f4f4; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #111; background: #111; color: #fff; cursor: pointer; font-size: 14px; }
    button.secondary { background: #fff; color: #111; }
    .grid-compact input { padding: 8px; }
    .hint { font-size: 12px; color: #555; margin-top: 4px; }
    .kpi { background: #f8f8ff; border: 1px dashed #bdbdfc; padding: 8px 10px; border-radius: 8px; font-size: 12px; color: #333; }
    .flex { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .divider { height: 1px; background: #eee; margin: 8px 0; }
    .right { text-align: right; }
    .switch { display:flex; align-items:center; gap:6px; font-size:12px; }
    .error { color:#b00020; font-size:12px; }
    @media print {
      header { position: static; }
      button, .switch { display: none; }
      body { background: #fff; }
      section { break-inside: avoid; }
    }
  </style>
</head>
<body>
  <header>
    <h1>Historia Clínica – Hernia Ventral Compleja (Ambulatorio)</h1>
    <div class="actions">
      <button id="btn-resumen">Ver resumen</button>
      <button id="btn-copiar" class="secondary">Copiar resumen</button>
      <label class="switch"><input type="checkbox" id="auto" checked> Auto‑resumen</label>
      <button class="secondary" onclick="window.print()">Imprimir / PDF</button>
      <button class="secondary" id="btn-limpiar">Limpiar</button>
    </div>
  </header>

  <main>
    <!-- 1) Identificación -->
    <section>
      <h2>1) Identificación y Motivo</h2>
      <div class="row grid-compact">
        <div class="col-4"><label>Nombre</label><input id="nombre" placeholder="Nombre y apellidos" /></div>
        <div class="col-2"><label>Documento</label><input id="doc" placeholder="CC / ID" /></div>
        <div class="col-2"><label>Edad</label><input id="edad" type="number" min="0" placeholder="años" /></div>
        <div class="col-2"><label>Sexo</label><select id="sexo"><option value=""></option><option>F</option><option>M</option></select></div>
        <div class="col-2"><label>Fecha</label><input id="fecha" type="date" /></div>
        <div class="col-12"><label>Motivo de consulta</label><input id="motivo" placeholder="Dolor, aumento de volumen, recidiva…" /></div>
      </div>
    </section>

    <!-- 2) Antecedentes -->
    <section>
      <h2>2) Antecedentes clave (rápido)</h2>
      <div class="row grid-compact">
        <div class="col-2"><label>Peso (kg)</label><input id="peso" type="number" step="0.1" /></div>
        <div class="col-2"><label>Talla (m)</label><input id="talla" type="number" step="0.01" /></div>
        <div class="col-2"><label>IMC</label><input id="imc" type="text" placeholder="auto" readonly /></div>
        <div class="col-3"><label>DM</label><select id="dm"><option></option><option>No</option><option>Tipo 2</option><option>Tipo 1</option></select></div>
        <div class="col-3"><label>Tabaquismo</label><select id="tabaco"><option></option><option>No</option><option>Actual</option><option>Exfumador</option></select></div>
        <div class="col-3"><label>Uso de anticoagulación</label><select id="ac"><option></option><option>No</option><option>Sí</option></select></div>
        <div class="col-3"><label>Alergias</label><input id="alergias" placeholder="—" /></div>
        <div class="col-3"><label>ASA</label><select id="asa"><option></option><option>I</option><option>II</option><option>III</option><option>IV</option></select></div>
        <div class="col-3"><label>Cirugías previas de pared</label><select id="previas"><option></option><option>Ninguna</option><option>1</option><option>2+</option></select></div>
        <div class="col-3"><label>Infección sitio Qx previa</label><select id="isq"><option></option><option>No</option><option>Sí</option></select></div>
      </div>
    </section>

    <!-- 3) Estado funcional -->
    <section>
      <h2>3) Estado funcional</h2>
      <div class="row grid-compact">
        <div class="col-3"><label>ECOG</label><select id="ecog"><option></option><option>0</option><option>1</option><option>2</option><option>3</option><option>4</option></select></div>
        <div class="col-3"><label>METs estimados</label><select id="mets"><option></option><option>&lt;4</option><option>4–7</option><option>&gt;7</option></select></div>
        <div class="col-6"><label>Limitaciones relevantes</label><input id="limitaciones" placeholder="Disnea, dolor, marcha, ortopnea…" /></div>
      </div>
      <div class="hint">Sugerencia rápida: ≥4 METs suele ser adecuado para cirugía electiva.</div>
      <div class="divider"></div>
      <div class="row grid-compact">
        <div class="col-6">
          <label><strong>Guía rápida ECOG</strong> — ¿Qué opción describe mejor al paciente?</label>
          <div class="flex" style="align-items:flex-start">
            <label class="chip"><input type="radio" name="ecog_crit" value="0"> 0: Asintomático; actividad normal</label>
            <label class="chip"><input type="radio" name="ecog_crit" value="1"> 1: Sintomático leve; ambulante</label>
            <label class="chip"><input type="radio" name="ecog_crit" value="2"> 2: &gt;50% del día en cama/silla</label>
            <label class="chip"><input type="radio" name="ecog_crit" value="3"> 3: &gt;50% del día postrado</label>
            <label class="chip"><input type="radio" name="ecog_crit" value="4"> 4: Totalmente postrado</label>
          </div>
          <div class="hint">Al elegir, se rellena ECOG (puedes editar después).</div>
        </div>
        <div class="col-6">
          <label><strong>Estimador de METs</strong> — Marca actividades que puede realizar:</label>
          <div class="flex" style="align-items:flex-start">
            <span class="chip"><input type="checkbox" class="mets_low"> Caminar en casa / autocuidado</span>
            <span class="chip"><input type="checkbox" class="mets_low"> Tareas ligeras</span>
            <span class="chip"><input type="checkbox" class="mets_mod"> Subir 1 piso de escaleras</span>
            <span class="chip"><input type="checkbox" class="mets_mod"> Caminar 6–7 km/h</span>
            <span class="chip"><input type="checkbox" class="mets_high"> Trotar / correr suave</span>
            <span class="chip"><input type="checkbox" class="mets_high"> Deportes intensos</span>
          </div>
          <div class="hint">Se estimará: &lt;4, 4–7, &gt;7 METs.</div>
        </div>
      </div>
    </section>

    <!-- 4) EHS -->
    <section>
      <h2>4) Hernia ventral – Clasificación EHS</h2>
      <div class="row grid-compact">
        <div class="col-4">
          <label>Localización (EHS)</label>
          <select id="ehs_loc">
            <option></option>
            <option>M1 Subxifoidea</option><option>M2 Epigástrica</option><option>M3 Umbilical</option>
            <option>M4 Infraumbilical</option><option>M5 Suprapúbica</option>
            <option>L1 Flanco superior</option><option>L2 Flanco lateral</option>
            <option>L3 Flanco inferior</option><option>L4 Lumbar</option>
          </select>
        </div>
        <div class="col-2"><label>Ancho defecto (cm)</label><input id="ancho" type="number" step="0.1" /></div>
        <div class="col-2"><label>Alto defecto (cm)</label><input id="alto" type="number" step="0.1" /></div>
        <div class="col-2"><label>Clase W (EHS)</label><input id="wclass" placeholder="W1/W2/W3" readonly /></div>
        <div class="col-2"><label>Reducibilidad</label><select id="reducible"><option></option><option>Reducible</option><option>Irreducible</option></select></div>
        <div class="col-3"><label>Tipo</label><select id="tipo"><option></option><option>Primaria</option><option>Incisional</option></select></div>
        <div class="col-3"><label>N° recidivas</label><select id="recidivas"><option></option><option>0</option><option>1</option><option>2+</option></select></div>
        <div class="col-3"><label>Estado piel/tejidos</label><select id="piel"><option></option><option>Íntegra</option><option>Fístula</option><option>Piel adelgazada</option><option>Úlcera</option></select></div>
        <div class="col-3"><label>Contaminación (CDC)</label><select id="cdc"><option></option><option>I Limpia</option><option>II Limpia-contaminada</option><option>III Contaminada</option><option>IV Sucia</option></select></div>
      </div>
      <div class="kpi">EHS W: W1 &lt;4 cm | W2 4–10 cm | W3 &gt;10 cm</div>
    </section>

    <!-- 5) Índices preop -->
    <section>
      <h2>5) Índices preoperatorios</h2>
      <div class="row grid-compact">
        <div class="col-3">
          <label>CeDAR / CEDAR (valor)</label><input id="cedar" placeholder="%" />
          <div class="hint">Ingrese el % de riesgo estimado si ya lo calculó.</div>
        </div>
        <div class="col-5">
          <label>Clasificación Carolinas (especifique)</label><input id="carolinas" placeholder="Nombre/versión empleada en su centro" />
          <div class="hint">Ej.: protocolo de preparación preoperatoria (Carolinas).</div>
        </div>
        <div class="col-4">
          <label>VHWG (opcional)</label><select id="vhwg"><option></option><option>I</option><option>II</option><option>III</option><option>IV</option></select>
          <div class="hint">Grupo de Trabajo en Hernia Ventral.</div>
        </div>
        <div class="col-12">
          <label>Notas de optimización preoperatoria</label>
          <div class="flex">
            <span class="chip"><input type="checkbox" id="opt_imc" /> IMC objetivo</span>
            <span class="chip"><input type="checkbox" id="opt_tabaco" /> Cese tabaco ≥4 sem</span>
            <span class="chip"><input type="checkbox" id="opt_dm" /> HbA1c &lt; 7.5%</span>
            <span class="chip"><input type="checkbox" id="opt_alb" /> Albúmina &gt; 3.5 g/dL</span>
            <span class="chip"><input type="checkbox" id="opt_botox" /> Toxina/Neumoperitoneo</span>
            <span class="chip"><input type="checkbox" id="opt_abd" /> Fajón/FT</span>
          </div>
        </div>
      </div>
    </section>

    <!-- 6) Estudios -->
    <section>
      <h2>6) Estudios e imágenes</h2>
      <div class="row grid-compact">
        <div class="col-4"><label>Imágenes</label><select id="img"><option></option><option>TAC</option><option>Eco pared</option><option>RM</option></select></div>
        <div class="col-8"><label>Hallazgos clave</label><input id="hallazgos" placeholder="Pérdida de dominio, diástasis, contenido, defectos múltiples…" /></div>
      </div>
    </section>

    <!-- 7) Plan -->
    <section>
      <h2>7) Plan quirúrgico y perioperatorio</h2>
      <div class="row grid-compact">
        <div class="col-4"><label>Técnica propuesta</label>
          <select id="tecnica"><option></option><option>Abierta</option><option>Laparoscópica</option><option>Robótica</option><option>Híbrida</option></select>
        </div>
        <div class="col-4"><label>Plano de reparación</label>
          <select id="plano"><option></option><option>Sublay/retromuscular</option><option>Onlay</option><option>Underlay/Intraperitoneal</option><option>Preperitoneal</option></select>
        </div>
        <div class="col-4"><label>Malla prevista</label>
          <select id="malla"><option></option><option>Sintética macroporosa</option><option>Reforzada/compuesta</option><option>Biológica</option></select>
        </div>
        <div class="col-12">
          <label>Terapias de preparación de pared</label>
          <div class="flex">
            <span class="chip"><input type="checkbox" id="plan_btx" /> Requiere toxina botulínica preoperatoria</span>
            <span class="chip"><input type="checkbox" id="plan_npp" /> Requiere neumoperitoneo progresivo preoperatorio</span>
          </div>
          <div class="hint">BTX: relajación parietal. NPP: ganancia de volumen abdominal.</div>
        </div>
        <div class="col-12"><label>Observaciones</label><textarea id="obs" placeholder="Liberación de componentes, TAR, drenajes, profilaxis, ERAS, etc."></textarea></div>
      </div>
    </section>

    <!-- 8) Consentimiento -->
    <section>
      <h2>8) Consentimiento y seguimiento</h2>
      <div class="row grid-compact">
        <div class="col-4"><label>Consentimiento informado</label><select id="consent"><option></option><option>Explicado y firmado</option><option>Pendiente</option></select></div>
        <div class="col-4"><label>Profilaxis tromboembólica</label><select id="tromb"><option></option><option>Estratificado y ordenado</option><option>Pendiente</option></select></div>
        <div class="col-4"><label>Antibiótico profiláctico</label><select id="abx"><option></option><option>Indicado</option><option>No indicado</option><option>Pendiente</option></select></div>
        <div class="col-12"><label>Plan de control</label><input id="control" placeholder="Control 7–10 días / herida; 30 días; 90 días." /></div>
      </div>
    </section>

    <!-- 9) Justificación -->
    <section>
      <h2>9) Justificación de terapias de optimización de pared</h2>
      <div class="muted">Se genera automáticamente si marcas BTX y/o NPP y presionas “Ver resumen”.</div>
      <div id="justificacion" class="kpi">Sin terapias seleccionadas.</div>
    </section>

    <!-- 10) Sugerencias automáticas -->
    <section>
      <h2>10) Sugerencias automáticas</h2>
      <div id="tev_sug" class="kpi">Sin sugerencias generadas. Use “Ver resumen”.</div>
    </section>

    <!-- Resumen -->
    <section>
      <h2>Resumen generado</h2>
      <div id="resumen" class="muted">Use “Ver resumen” (o active Auto‑resumen) para generar un texto listo para copiar al EHR.</div>
      <div id="err" class="error"></div>
    </section>

    <div class="divider"></div>
    <p class="muted right">v1.4 · Interactivo, con justificativos para asegurador, sugerencias TEV y auto‑resumen</p>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);
    const on = (el, ev, fn) => el && el.addEventListener(ev, fn);
    const debounce = (fn, d=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d);} };

    // === Cálculos básicos ===
    function calcIMC() {
      const pEl = $('peso'), tEl = $('talla'), imcEl = $('imc');
      if (!pEl || !tEl || !imcEl) return;
      const p = parseFloat(pEl.value), t = parseFloat(tEl.value);
      imcEl.value = (p>0 && t>0) ? (p/(t*t)).toFixed(1) : '';
    }
    function calcW() {
      const aEl = $('ancho'), wEl = $('wclass');
      if (!aEl || !wEl) return;
      const w = parseFloat(aEl.value);
      if (isNaN(w)) { wEl.value=''; return; }
      wEl.value = (w < 4) ? 'W1' : (w <= 10 ? 'W2' : 'W3');
    }

    // === Estimador METs
    function recalcMETsFromChecks() {
      const any = cls => Array.from(document.querySelectorAll(cls)).some(c=>c.checked);
      const mets = $('mets');
      if (!mets) return;
      if (any('.mets_high')) mets.value = '>7';
      else if (any('.mets_mod')) mets.value = '4–7';
      else if (any('.mets_low')) mets.value = '<4';
      else mets.value = '';
    }

    // === Sugerencia TEV ===
    function sugTEV() {
      const factors = [];
      const edadEl=$('edad'), imcEl=$('imc'), ecogEl=$('ecog'), tecnicaEl=$('tecnica'), acEl=$('ac'), asaEl=$('asa');
      const edad = edadEl? parseInt(edadEl.value||'0',10):0;
      const imc = imcEl? parseFloat(imcEl.value):NaN;
      const ecog = ecogEl && ecogEl.value!=='' ? parseInt(ecogEl.value,10) : null;
      const tecnica = tecnicaEl? tecnicaEl.value: '';
      const ac = acEl? acEl.value: '';
      const asa = asaEl? asaEl.value: '';

      if (!isNaN(edad) && edad >= 60) factors.push('edad ≥60');
      if (!isNaN(imc) && imc >= 30) factors.push('IMC ≥30');
      if (ecog !== null && ecog >= 2) factors.push(`ECOG ${ecog} (movilidad reducida)`);
      if (tecnica === 'Abierta') factors.push('cirugía abierta');
      if (ac === 'Sí') factors.push('anticoagulación crónica');
      if (asa === 'III' || asa === 'IV') factors.push(`ASA ${asa}`);

      let nivel = 'bajo';
      if (factors.length >= 3 || (ecog !== null && ecog >= 2) || (!isNaN(imc) && imc >= 35)) nivel = 'alto';
      else if (factors.length === 2) nivel = 'moderado';
      else if (factors.length === 1) nivel = 'leve';

      let recomendacion = '';
      if (nivel === 'bajo' || nivel === 'leve') recomendacion = 'Deambulación temprana + medidas mecánicas según criterio.';
      else if (nivel === 'moderado') recomendacion = 'Profilaxis farmacológica estándar (p. ej., HBPM dosis profiláctica) + compresión mecánica.';
      else recomendacion = 'Profilaxis combinada: HBPM dosis profiláctica (o ajuste según función renal) + compresión neumática intermitente; considerar prolongación 7–14 días.';

      const txt = `Sugerencia TEV: Riesgo ${nivel}. Factores: ${factors.join(', ') || 'sin factores mayores detectados'}. Recomendación: ${recomendacion}`;
      const box = $('tev_sug'); if (box) box.textContent = txt;
      const sel = $('tromb'); if (sel && nivel) sel.value = 'Estratificado y ordenado';
      return txt;
    }

    // === Resumen + Justificación ===
    function resumenTexto() {
      const parts = [];
      const nombre = ($('nombre')?.value || 'Paciente');
      const edad = $('edad')?.value ? (', ' + $('edad').value + ' años') : '';
      const sexo = $('sexo')?.value ? (' (' + $('sexo').value + ')') : '';
      const fecha = $('fecha')?.value ? (' – ' + $('fecha').value) : '';
      parts.push(`Consulta ambulatoria de ${nombre}${edad}${sexo}${fecha}.`);

      const motivo = $('motivo')?.value; if (motivo) parts.push(`Motivo: ${motivo}.`);

      const imcTxt = $('imc')?.value ? ` IMC ${$('imc').value}` : '';
      const asa = $('asa')?.value ? `, ASA ${$('asa').value}` : '';
      const dm = $('dm')?.value ? `, DM: ${$('dm').value}` : '';
      const tab = $('tabaco')?.value ? `, Tabaquismo: ${$('tabaco').value}` : '';
      const ac = $('ac')?.value ? `, Anticoagulación: ${$('ac').value}` : '';
      const isq = $('isq')?.value ? `, ISQ previa: ${$('isq').value}` : '';
      const prev = $('previas')?.value ? `, Cirugías pared previas: ${$('previas').value}` : '';
      const al = $('alergias')?.value ? `, Alergias: ${$('alergias').value}` : '';
      if ($('peso')?.value || $('talla')?.value || $('asa')?.value || $('dm')?.value || $('tabaco')?.value || $('ac')?.value || $('isq')?.value || $('previas')?.value || $('alergias')?.value) {
        parts.push(`Antecedentes clave:${imcTxt}${asa}${dm}${tab}${ac}${isq}${prev}${al}.`);
      }

      // EHS
      const ehsLoc = $('ehs_loc')?.value;
      const an = $('ancho')?.value, al2 = $('alto')?.value, wclass = $('wclass')?.value;
      const tipo = $('tipo')?.value, recid = $('recidivas')?.value, red = $('reducible')?.value;
      const piel = $('piel')?.value, cdc = $('cdc')?.value;
      const ehs = [];
      if (ehsLoc) ehs.push(ehsLoc);
      if (an) ehs.push(`ancho ${an} cm`);
      if (al2) ehs.push(`alto ${al2} cm`);
      if (wclass) ehs.push(wclass);
      if (tipo) ehs.push(tipo);
      if (recid) ehs.push(`${recid} recidivas`);
      if (red) ehs.push(red.toLowerCase());
      if (piel) ehs.push(`piel: ${piel.toLowerCase()}`);
      if (cdc) ehs.push(`CDC: ${cdc}`);
      if (ehs.length) parts.push(`Hernia ventral (EHS): ${ehs.join(', ')}.`);

      // Índices
      const cedar = $('cedar')?.value, car = $('carolinas')?.value, vhwg = $('vhwg')?.value;
      const idx = [];
      if (cedar) idx.push(`CeDAR ${cedar}`);
      if (car) idx.push(`Carolinas: ${car}`);
      if (vhwg) idx.push(`VHWG ${vhwg}`);
      const opt = [];
      if ($('opt_imc')?.checked) opt.push('IMC optimizado');
      if ($('opt_tabaco')?.checked) opt.push('cese tabaco');
      if ($('opt_dm')?.checked) opt.push('control glucémico');
      if ($('opt_alb')?.checked) opt.push('nutrición/albumina');
      if ($('opt_botox')?.checked) opt.push('BTX/NPP valorado');
      if ($('opt_abd')?.checked) opt.push('faja/FT');
      if (idx.length || opt.length) parts.push(`Índices preoperatorios: ${idx.join(', ')}${opt.length ? '; Optimización: ' + opt.join(', ') : ''}.`);

      // Estudios
      const img = $('img')?.value, hall = $('hallazgos')?.value;
      if (img || hall) parts.push(`Estudios: ${img ? img + '; ' : ''}${hall ? hall : ''}.`);

      // Plan
      const tec = $('tecnica')?.value, plano = $('plano')?.value, malla = $('malla')?.value, obs = $('obs')?.value;
      const btx = $('plan_btx')?.checked, npp = $('plan_npp')?.checked;
      const plan = [];
      if (tec) plan.push(tec);
      if (plano) plan.push(plano);
      if (malla) plan.push(`malla ${malla.toLowerCase()}`);
      if (btx) plan.push('BTX preoperatoria');
      if (npp) plan.push('NPP preoperatorio');
      if (plan.length || obs) parts.push(`Plan: ${plan.join(', ')}${obs ? '. ' + obs : ''}.`);

      // Perioperatorio
      const cons = $('consent')?.value, tromb = $('tromb')?.value, abx = $('abx')?.value, ctrl = $('control')?.value;
      const peri = [];
      if (cons) peri.push(`consentimiento ${cons.toLowerCase()}`);
      if (tromb) peri.push(`profilaxis TEV ${tromb.toLowerCase()}`);
      if (abx) peri.push(`ATB ${abx.toLowerCase()}`);
      if (ctrl) peri.push(`control: ${ctrl}`);
      if (peri.length) parts.push(`Perioperatorio: ${peri.join(', ')}.`);

      // Justificación BTX/NPP + TEV
      const justParts = [];
      if (btx || npp) {
        const imcVal = parseFloat($('imc')?.value);
        const ecogVal = $('ecog')?.value ? parseInt($('ecog').value, 10) : null;
        const cdcVal = $('cdc')?.value;
        const wClass = $('wclass')?.value;
        const hallTxt = ( $('hallazgos')?.value || '' ).toLowerCase();
        const ehsLocTxt = $('ehs_loc')?.value;
        const anchoVal = $('ancho')?.value;
        const tipoHernia = $('tipo')?.value;

        const perdidaDominio = /p[eé]rdida\s+de\s+dominio/.test(hallTxt);
        const dias = /di[aá]stasis/.test(hallTxt);
        const multiplDefectos = /m[uú]ltiples?|m[uú]ltiple/.test(hallTxt);

        const factores = [];
        if (wClass === 'W2' || wClass === 'W3') factores.push(`defecto ${wClass}${anchoVal ? ' (ancho ' + anchoVal + ' cm)' : ''}`);
        if (perdidaDominio) factores.push('pérdida de dominio en imágenes');
        if (!isNaN(imcVal)) {
          if (imcVal >= 35) factores.push('IMC ≥35 (alto riesgo tensional)');
          else if (imcVal >= 30) factores.push('IMC ≥30');
        }
        if (ecogVal !== null && ecogVal >= 2) factores.push(`ECOG ${ecogVal}`);
        if (cdcVal && /II|III|IV/.test(cdcVal)) factores.push(`campo ${cdcVal} (CDC)`);
        if (dias) factores.push('diástasis');
        if (multiplDefectos) factores.push('defectos múltiples');
        if (tipoHernia) factores.push(`hernia ${tipoHernia.toLowerCase()}`);
        if (ehsLocTxt) factores.push(`localización ${ehsLocTxt.toLowerCase()}`);

        const criteriosCaso = factores.length ? ` Criterios del caso: ${factores.join(', ')}.` : '';

        if (btx) justParts.push('• Toxina botulínica preoperatoria: relajación de musculatura lateral, mayor complacencia abdominal y cierre sin tensión; posible reducción de dehiscencia/ISQ.');
        if (npp) justParts.push('• Neumoperitoneo progresivo: expansión gradual de cavidad y adaptación diafragmática; mejora factibilidad de cierre y reduce complicaciones respiratorias.');
        justParts.push('Medidas incluidas en protocolos modernos de optimización preoperatoria en hernias ventrales complejas.' + criteriosCaso);

        const tevSug = sugTEV();
        if (tevSug) justParts.push('Justificación riesgo TEV: ' + tevSug);
      }
      const justTxt = justParts.join(' ');
      const jEl = $('justificacion'); if (jEl) jEl.textContent = justTxt || 'Sin terapias seleccionadas.';

      return parts.join(' ');
    }

    function generateSummary() {
      try {
        const txt = resumenTexto();
        const r = $('resumen'); if (r) r.textContent = txt;
      } catch (err) {
        const e = $('err'); if (e) e.textContent = 'Error al generar el resumen: ' + (err?.message || err);
      }
    }

    async function copySummary() {
      const r = $('resumen'); if (!r) return;
      const txt = r.textContent || '';
      try {
        if (navigator.clipboard && window.isSecureContext) {
          await navigator.clipboard.writeText(txt);
        } else {
          const ta = document.createElement('textarea');
          ta.value = txt; document.body.appendChild(ta);
          ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        }
      } catch (err) {
        const e = $('err'); if (e) e.textContent = 'No se pudo copiar automáticamente. Copia manualmente el texto del resumen.';
      }
    }

    function wire() {
      on($('btn-resumen'), 'click', generateSummary);
      on($('btn-copiar'), 'click', copySummary);
      on($('btn-limpiar'), 'click', () => {
        document.querySelectorAll('input, select, textarea').forEach(el => {
          if (el.id === 'imc' || el.id === 'wclass') { el.value = ''; }
          else if (el.type === 'checkbox' || el.type === 'radio') { el.checked = false; }
          else { el.value = ''; }
        });
        const r = $('resumen'); if (r) r.textContent = 'Use “Ver resumen” (o active Auto‑resumen) para generar un texto listo para copiar al EHR.';
        const t = $('tev_sug'); if (t) t.textContent = 'Sin sugerencias generadas. Use “Ver resumen”.';
        const j = $('justificacion'); if (j) j.textContent = 'Sin terapias seleccionadas.';
        const e = $('err'); if (e) e.textContent = '';
      });

      // Cálculos
      on($('peso'), 'input', calcIMC);
      on($('talla'), 'input', calcIMC);
      on($('ancho'), 'input', calcW);

      // ECOG guiado
      document.querySelectorAll('input[name="ecog_crit"]').forEach(r => on(r, 'change', (e)=>{ const el=$('ecog'); if (el) el.value=e.target.value; }));
      // METs guiado
      document.querySelectorAll('.mets_high, .mets_mod, .mets_low').forEach(c => on(c, 'change', recalcMETsFromChecks));

      // Auto-resumen
      const toggle = $('auto');
      const autoHandler = debounce(()=>{ if (toggle && toggle.checked) generateSummary(); }, 200);
      on(document, 'input', autoHandler);
      on(document, 'change', autoHandler);

      // Primer render
      generateSummary();
    }

    window.addEventListener('DOMContentLoaded', wire);
  </script>
</body>
</html>
